var e,t;e=this,t=function(){"use strict";function e(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,"string");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(t,n){for(var o=0;o<n.length;o++){var r=n[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,e(r.key),r)}}function o(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function r(e){return"local"===e?"http://localhost:8888":"prod-https"===e?"https://sdk-metrics.g.globo":"prod-http"===e||"qa-http"===e?"http://sdk-metrics.g.globo":"https://sdk-metrics.g.globo"}var i=function(){return o((function e(n,o,i){t(this,e),this.platform=o,this.request=i,this.abHost=function(e){return"local"===e?"http://localhost:8888":"prod-https"===e?"https://ab.g.globo":"prod-http"===e?"http://ab.g.globo":"qa-http"===e?"http://ab.qa.globoi.com":"qa-https"===e?"https://ab.qa.globoi.com":"pre-prod-http"===e?"http://34.151.249.98":"https://ab.g.globo"}(n),this.metricsHost=r(n)}),[{key:"chooseWithContent",value:function(e,t,n,o){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],i=arguments.length>5?arguments[5]:void 0,s=arguments.length>6?arguments[6]:void 0,a=arguments.length>7?arguments[7]:void 0,u=arguments.length>8?arguments[8]:void 0,l=this.platform.getExtraParams(),c=l["forced-experiment"],h=l["forced-alternative"];for(var d in e)if(Object.prototype.hasOwnProperty.call(e,d)&&e[d].name===c&&h){e[d].forcedAlternative=h;break}var p=Object.assign({},{experiments:e},t?{userId:t}:null,n?{glbExpIdToken:n}:null,o?{hsIdToken:o}:null,i?{userIdType:i}:null);this.request.do(this.abHost,"/choose","POST",{},p,a,u,null!==r&&r.length?r:s.getHeaders(),s.getTimeout())}},{key:"chooseWithoutContent",value:function(e,t,n,o){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],i=arguments.length>5?arguments[5]:void 0,s=arguments.length>6?arguments[6]:void 0,a=arguments.length>7?arguments[7]:void 0,u=arguments.length>8?arguments[8]:void 0,l=this.platform.getExtraParams(),c=l["forced-experiment"],h=l["forced-alternative"],d=Object.assign({},{experiments:e},t?{userId:t}:null,n?{glbExpIdToken:n}:null,o?{hsIdToken:o}:null,i?{userIdType:i}:null,c?{forcedExperiment:c}:null,h?{forcedAlternative:h}:null);this.request.do(this.abHost,"/choose","GET",d,null,a,u,null!==r&&r.length?r:s.getHeaders())}},{key:"isolationChoose",value:function(e,t,n,o){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],i=arguments.length>5?arguments[5]:void 0,s=arguments.length>6?arguments[6]:void 0,a=arguments.length>7?arguments[7]:void 0,u=arguments.length>8?arguments[8]:void 0,l=this.platform.getExtraParams(),c=l["forced-experiment"],h=l["forced-alternative"],d=Object.assign({},{isolationGroup:e.getName()},e.getGenerateImpression()?{generateImpression:e.getGenerateImpression()}:null,t?{userId:t}:null,n?{glbExpIdToken:n}:null,o?{hsIdToken:o}:null,i?{userIdType:i}:null,c?{forcedExperiment:c}:null,h?{forcedAlternative:h}:null);this.request.do(this.abHost,"/isolation/choose","GET",d,null,a,u,null!==r&&r.length?r:s.getHeaders())}},{key:"recordMetric",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2?arguments[2]:void 0;this.request.sendBeacon(this.abHost,"/event",e,null!==t&&t.length?t:n.getHeaders(),n.getTimeout())}},{key:"sendPerformanceMetrics",value:function(e){this.request.sendBeacon(this.metricsHost,"/api/v1/performance",e)}}])}(),s={GLOBO_ID:"GLOBO_ID",GLOBOID:"globoId",GLB_UID:"glb_uid"},a={AB:"ab",MAB:"mab",ISOLATION:"isolation"},u=function(){return o((function e(n,o,r){t(this,e),this.platform=o,this.abEndpoint=new i(n,o,r),this.blacklist=[],this.ChooseType=a}),[{key:"choose",value:function(e,t,n,o,r,i,s){return Array.isArray(e)&&e.length>0?e.some((function(e){return null!==e.getContext()&&e.getContext().length>0||void 0!==(t=e.getGenerateImpression())&&!0===t;var t}))?this._chooseWithContent(e,t,n,o,r,i,s):this._chooseWithoutContent(e,t,n,o,r,i,s):Promise.reject(new TypeError("The experiment parameter must be a list of Experiment objects."))}},{key:"isolationChoose",value:function(e,t,n,o,r,i,s){return e?this._isolationChoose(e,t,n,o,r,i,s):Promise.reject(new TypeError("The isolationGroup parameter must be a IsolationGroup object."))}},{key:"impression",value:function(e,t,n,o,r,i,s){e.event="impression",this.blacklist&&this.blacklist.includes(e.experiment)?console.warn("Event "+e.event+" cannot be sent. Check if the experiment is inactive, forced or finished."):(t&&(e.userId=t),n&&(e.glbExpIdToken=n),o&&(e.hsIdToken=o),i&&(e.userIdType=i),this.abEndpoint.recordMetric(e,r,s))}},{key:"conversion",value:function(e,t,n,o,r,i,s){e.event="conversion",this.blacklist&&this.blacklist.includes(e.experiment)?console.warn("Event "+e.event+" cannot be sent. Check if the experiment is inactive, forced or finished."):(t&&(e.userId=t),n&&(e.glbExpIdToken=n),o&&(e.hsIdToken=o),i&&(e.userIdType=i),this.abEndpoint.recordMetric(e,r,s))}},{key:"_chooseWithoutContent",value:function(e,t,n,o,r,i,s){var a=this,u=e.map((function(e){return e.name})).join(",");return new Promise((function(e,l){a.abEndpoint.chooseWithoutContent(u,t,n,o,r,i,s,(function(t){var n=performance.now(),o=a._parseRequest(t,n);e(o),setTimeout((function(){var e=o.experiments.map((function(e){return{testId:e.testId,name:e.name}})),t={latency:o.latency,experiments:e,platform:a.platform.getEnvironmentInfo(),sdk:"web",timestamp:Math.floor(Date.now()/1e3),version:"4.5.7",statusCode:o.statusCode,keys:{chooseType:a.ChooseType.AB}};a.abEndpoint.sendPerformanceMetrics(t)}),250)}),(function(e){l(e)}))}))}},{key:"_chooseWithContent",value:function(e,t,n,o,r,i,s){var a=this;return new Promise((function(u,l){a.abEndpoint.chooseWithContent(e,t,n,o,r,i,s,(function(e){var t=performance.now(),n=a._parseRequest(e,t);u(n),setTimeout((function(){var e=n.experiments.map((function(e){return{testId:e.testId,name:e.name}})),t={latency:n.latency,experiments:e,platform:a.platform.getEnvironmentInfo(),sdk:"web",timestamp:Math.floor(Date.now()/1e3),version:"4.5.7",statusCode:n.statusCode,keys:{chooseType:a.ChooseType.AB}};a.abEndpoint.sendPerformanceMetrics(t)}),250)}),(function(e){l(e)}))}))}},{key:"_isolationChoose",value:function(e,t,n,o,r,i,s){var a=this;return new Promise((function(u,l){a.abEndpoint.isolationChoose(e,t,n,o,r,i,s,(function(e){var t=performance.now(),n=a._parseRequest(e,t);u(n),setTimeout((function(){var e=n.experiments.map((function(e){return{testId:e.testId,name:e.name}})),t={latency:n.latency,experiments:e,platform:a.platform.getEnvironmentInfo(),sdk:"web",timestamp:Math.floor(Date.now()/1e3),version:"4.5.7",statusCode:n.statusCode,keys:{chooseType:a.ChooseType.ISOLATION}};a.abEndpoint.sendPerformanceMetrics(t)}),250)}),(function(e){l(e)}))}))}},{key:"_parseRequest",value:function(e,t){var n=JSON.parse(e.responseText);n.latency=parseFloat((t-e.timeTriggerRequest).toFixed(1)),n.statusCode=e.status;var o=n.experiments;this.blacklist=[];for(var r=0;r<o.length;r++){var i=o[r];i["extra-info"]&&!1===i["extra-info"]["draw-rule"]["process-event"]&&this.blacklist.push(i.name)}return n}}])}(),l=function(){return o((function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];t(this,e),this.name=n,this.context=null!==o?o:[],this.generateImpression=r}),[{key:"_canProcessEvent",value:function(){return!(this.data&&this.data["extra-info"]&&this.data["extra-info"]["draw-rule"]&&void 0!==this.data["extra-info"]["draw-rule"]["process-event"])||this.data["extra-info"]["draw-rule"]["process-event"]}},{key:"setName",value:function(e){return this.name=e,this}},{key:"getName",value:function(){return this.name}},{key:"setContext",value:function(e){return this.context=null!==e?e:[],this}},{key:"getContext",value:function(){return this.context}},{key:"setGenerateImpression",value:function(e){return this.generateImpression=e,this}},{key:"getGenerateImpression",value:function(){return this.generateImpression}}])}(),c=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,e),this.options=n}return o(e,[{key:"getHeaders",value:function(){return this.options.extraHeaders||[]}},{key:"getHeader",value:function(e){var t="";return this.getHeaders().forEach((function(n){Object.keys(n).forEach((function(o){e===o&&(t=n[o])}))})),t}},{key:"getTimeout",value:function(){var e=this.options.timeout;return void 0===e&&(e=1e3),e}},{key:"setTimeout",value:function(e){return this.options.timeout=e,this}},{key:"addHeader",value:function(e){var t=[];Object.prototype.hasOwnProperty.call(this.options,"extraHeaders")&&(t=this.options.extraHeaders);var n=t.findIndex((function(t){return Object.keys(t).some((function(t){return t===Object.keys(e)[0]}))}));return-1!==n?t[n]=e:t.push(e),this.options.extraHeaders=t,this}},{key:"addHeaders",value:function(e){var t=[];return Object.prototype.hasOwnProperty.call(this.options,"extraHeaders")&&(t=this.options.extraHeaders),e.forEach((function(e){var n=Object.keys(e)[0],o=t.findIndex((function(e){return Object.keys(e)[0]===n}));-1!==o?t[o]=e:t.push(e)})),this.options.extraHeaders=t,this}},{key:"withOriginURL",value:function(t){return new e(this.clone(this.options)).originURL(t)}},{key:"originURL",value:function(e){return this.addHeader({"x-canonical-uri":e}),this}},{key:"getOriginURL",value:function(){return this.getHeader("x-canonical-uri")}}])}(),h=function(){return o((function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t(this,e),this.name=n,this.generateImpression=o}),[{key:"_canProcessEvent",value:function(){return!(this.data&&this.data["extra-info"]&&this.data["extra-info"]["draw-rule"]&&void 0!==this.data["extra-info"]["draw-rule"]["process-event"])||this.data["extra-info"]["draw-rule"]["process-event"]}},{key:"setName",value:function(e){return this.name=e,this}},{key:"getName",value:function(){return this.name}},{key:"setGenerateImpression",value:function(e){return this.generateImpression=e,this}},{key:"getGenerateImpression",value:function(){return this.generateImpression}}])}(),d=function(){return o((function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"prod-https",o=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;t(this,e),this.abMain=new u(n,o,r),this._options=new c,this.UserIdType=s}),[{key:"createExperiment",value:function(e,t,n){return new l(e,t,n)}},{key:"createIsolationGroup",value:function(e,t,n){return new h(e,t,n)}},{key:"choose",value:function(e,t,n,o,r,i){return this.abMain.choose(e,t,n,o,r,i,this._options)}},{key:"isolationChoose",value:function(e,t,n,o,r,i){return this.abMain.isolationChoose(e,t,n,o,r,i,this._options)}},{key:"impression",value:function(e,t,n,o,r,i){this.abMain.impression(e,t,n,o,r,i,this._options)}},{key:"conversion",value:function(e,t,n,o,r,i){this.abMain.conversion(e,t,n,o,r,i,this._options)}},{key:"addHeader",value:function(e){return this._options.addHeader(e),this}},{key:"addHeaders",value:function(e){return this._options.addHeaders(e),this}},{key:"getHeaders",value:function(){return this._options.getHeaders()}},{key:"setTimeout",value:function(e){return this._options.setTimeout(e),this}}])}(),p=function(){return o((function e(n,o){t(this,e),this.request=o,this.mabHost=function(e){return"local"===e?"http://localhost:8888":"prod-https"===e?"https://mab.g.globo":"prod-http"===e?"http://mab.g.globo":"qa-http"===e?"http://mab.qa.globoi.com":"qa-https"===e?"https://mab.qa.globoi.com":"pre-prod-http"===e?"http://34.151.249.98":"https://mab.g.globo"}(n),this.metricsHost=r(n)}),[{key:"chooseWithoutContent",value:function(e,t,n,o){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],i=arguments.length>5?arguments[5]:void 0,s=arguments.length>6?arguments[6]:void 0,a=arguments.length>7?arguments[7]:void 0,u=arguments.length>8?arguments[8]:void 0,l=Object.assign({},{experiments:e},t?{userId:t}:null,n?{glbExpIdToken:n}:null,o?{hsIdToken:o}:null,i?{userIdType:i}:null);this.request.do(this.mabHost,"/choose","GET",l,null,a,u,null!==r&&r.length?r:s.getHeaders(),s.getTimeout())}},{key:"recordMetric",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2?arguments[2]:void 0;this.request.do(this.mabHost,"/event","POST",{},e,null,null,null!==t&&t.length?t:n.getHeaders(),n.getTimeout())}},{key:"sendPerformanceMetrics",value:function(e){this.request.sendBeacon(this.metricsHost,"/api/v1/performance",e)}}])}(),f=function(){return o((function e(n,o,r){t(this,e),this.platform=o,this.mabEndpoint=new p(n,r),this.ChooseType=a}),[{key:"increment",value:function(e,t,n,o,r,i,s){e.event="increment",t&&(e.userId=t),n&&(e.glbExpIdToken=n),o&&(e.hsIdToken=o),i&&(e.userIdType=i),this.mabEndpoint.recordMetric(e,r,s)}},{key:"reward",value:function(e,t,n,o,r,i,s){e.event="reward",t&&(e.userId=t),n&&(e.glbExpIdToken=n),o&&(e.hsIdToken=o),i&&(e.userIdType=i),this.mabEndpoint.recordMetric(e,r,s)}},{key:"choose",value:function(e,t,n,o,r,i,s){return Array.isArray(e)&&e.length>0?this._chooseWithoutContent(e,t,n,o,r,i,s):Promise.reject(new TypeError("The experiment parameter must be a list of Experiment objects."))}},{key:"_chooseWithoutContent",value:function(e,t,n,o,r,i,s){var a=this,u=e.map((function(e){return e.name})).join(",");return new Promise((function(e,l){a.mabEndpoint.chooseWithoutContent(u,t,n,o,r,i,s,(function(t){var n=performance.now(),o=a._parseRequest(t,n);e(o),setTimeout((function(){var e=o.experiments.map((function(e){return{testId:e.testId,name:e.name}})),t={latency:o.latency,experiments:e,platform:a.platform.getEnvironmentInfo(),sdk:"web",timestamp:Math.floor(Date.now()/1e3),version:"4.5.7",statusCode:o.statusCode,keys:{chooseType:a.ChooseType.MAB}};a.mabEndpoint.sendPerformanceMetrics(t)}),250)}),(function(e){l(e)}))}))}},{key:"_parseRequest",value:function(e,t){var n=JSON.parse(e.responseText);return n.latency=parseFloat((t-e.timeTriggerRequest).toFixed(1)),n.statusCode=e.status,n}}])}(),m=function(){return o((function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t(this,e),this.name=n,this.generateImpression=o}),[{key:"increment",value:function(){var e=this.arms;0===e.length&&(e=[{slot:0,name:this.arm}]),this._sendMetric("increment",e)}},{key:"reward",value:function(){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",t=[{slot:arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,name:""===e?this.arm:e}];this._sendMetric("reward",t)}},{key:"_sendMetric",value:function(e,t){var n={experiment:this.experiment,arm:this.arm,testId:this.testId,abAlternative:this.abAlternative,arms:t};this._recordMetric(e,n)}},{key:"_recordMetric",value:function(e,t){this.context.mabEndpoint.recordMABMetric(e,t,this.options)}},{key:"setGenerateImpression",value:function(e){return this.generateImpression=e,this}},{key:"getGenerateImpression",value:function(){return this.generateImpression}}])}(),v=function(){return o((function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"prod-https",o=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;t(this,e),this.mabMain=new f(n,o,r),this._options=new c,this.UserIdType=s}),[{key:"createExperiment",value:function(e,t){return new m(e,t)}},{key:"choose",value:function(e,t,n,o,r,i){return this.mabMain.choose(e,t,n,o,r,i,this._options)}},{key:"increment",value:function(e,t,n,o,r,i){this.mabMain.increment(e,t,n,o,r,i,this._options)}},{key:"reward",value:function(e,t,n,o,r,i){this.mabMain.reward(e,t,n,o,r,i,this._options)}},{key:"addHeader",value:function(e){return this._options.addHeader(e),this}},{key:"addHeaders",value:function(e){return this._options.addHeaders(e),this}},{key:"getHeaders",value:function(){return this._options.getHeaders()}},{key:"setTimeout",value:function(e){return this._options.setTimeout(e),this}}])}(),g=function(){return o((function e(){t(this,e)}),[{key:"getExtraParams",value:function(){var e={},t=["forced-experiment","forced-alternative"],n=this.getDocumentLocationSearch().substr(1).split("&");for(var o in n)if(Object.prototype.hasOwnProperty.call(n,o)){var r=n[o].split("=");t.indexOf(r[0])>-1&&(e[r[0]]=r[1])}return e}},{key:"getDocumentLocationSearch",value:function(){return document.location.search}},{key:"getEnvironmentInfo",value:function(){var e=navigator.platform,t=navigator.userAgent;return t.match(/Firefox\/([0-9]+\.[0-9]+)/)?"Firefox "+t.match(/Firefox\/([0-9]+\.[0-9]+)/)[1]+" ("+e+")":t.match(/Chrome\/([0-9]+\.[0-9]+)/)?"Chrome "+t.match(/Chrome\/([0-9]+\.[0-9]+)/)[1]+" ("+e+")":t.match(/MSIE ([0-9]+\.[0-9]+)/)?"Internet Explorer "+t.match(/MSIE ([0-9]+\.[0-9]+)/)[1]+" ("+e+")":t.match(/Safari\/([0-9]+\.[0-9]+)/)?"Safari "+t.match(/Safari\/([0-9]+\.[0-9]+)/)[1]+" ("+e+")":t.match(/Opera\/([0-9]+\.[0-9]+)/)?"Opera "+t.match(/Opera\/([0-9]+\.[0-9]+)/)[1]+" ("+e+")":t.match(/Edg\/([0-9]+\.[0-9]+)/)?"Edge "+t.match(/Edg\/([0-9]+\.[0-9]+)/)[1]+" ("+e+")":"Unknown"}}])}(),y=function(){return o((function e(){t(this,e)}),[{key:"sendBeacon",value:function(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e3,i=void 0!==globalThis.navigator&&"function"==typeof globalThis.navigator.sendBeacon,s=null!=o&&o.length>0;i&&!s?function(e,t,n){var o=new Blob([JSON.stringify(n)],{type:"application/json"});window.navigator.sendBeacon(e+t,o)}(e,t,n):this.oneWaySend(e,t,n,o,r)}},{key:"oneWaySend",value:function(e,t,n,o,r){this.do(e,t,"POST",null,n,null,null,o,r)}},{key:"do",value:function(e,t,n,o,r,i,s){var a=this,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:[],l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1e3,c="";for(var h in o)Object.prototype.hasOwnProperty.call(o,h)&&(c+="&"+h+"="+o[h]);c&&(c="?"+c.substring(1));var d=e+t+c,p=this.createXHR();p.open(n,d,!0),p.timeout=l,p.onload=function(){p.status>=200&&p.status<400?a.callIfDefined(i,p):a.callIfDefined(s,a.handleError(p,d))},p.onerror=function(e){a.callIfDefined(s,a.handleError(e,d))},p.ontimeout=function(e){a.callIfDefined(s,a.handleError(e,d))},r&&(p.setRequestHeader("Content-Type","application/json;charset=utf-8"),r=JSON.stringify(r)),Array.from(u).forEach((function(e){Object.keys(e).forEach((function(t){p.setRequestHeader(t,e[t])}))})),p.timeTriggerRequest=performance.now(),p.send(r)}},{key:"handleError",value:function(e,t){var n={};return n.type=e.type?e.type:"undefined",e.target instanceof XMLHttpRequest&&(e=e.target),e instanceof XMLHttpRequest?(n.status=e.status,n.url=t,n.timeout=e.timeout,n.msg=e.responseText):n.msg=e.toString(),n}},{key:"createXHR",value:function(){var e=new XMLHttpRequest;return e.withCredentials=!1,e}},{key:"callIfDefined",value:function(e,t){e&&e(t)}}])}(),b=function(){return o((function e(){t(this,e),this.platform=new g,this.request=new y}),[{key:"ab",value:function(){return new d(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"prod",this.platform,this.request)}},{key:"mab",value:function(){return new v(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"prod",this.platform,this.request)}},{key:"getVersion",value:function(){return"4.5.7"}}])}();return b},"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).GloboAbSdk=t();
